<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskOracle AI - AI (v1.6.0 - Gyan Sagar AI)</title>
    <style>
        /* Global Styles & CSS Variables */
        :root {
            --font-primary: 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            --bg-primary-light: #f8f9fa; --bg-secondary-light: #ffffff; --text-primary-light: #212529; --text-secondary-light: #6c757d; --accent-color-light: #007bff; --accent-hover-light: #0056b3; --border-color-light: #dee2e6; --card-shadow-light: 0 4px 8px rgba(0, 0, 0, 0.05); --button-shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1); --success-color-light: #28a745; --danger-color-light: #dc3545;
            --bg-primary-dark: #121212; --bg-secondary-dark: #1e1e1e; --text-primary-dark: #e0e0e0; --text-secondary-dark: #a0a0a0; --accent-color-dark: #0097ff; --accent-hover-dark: #007acc; --border-color-dark: #333333; --card-shadow-dark: 0 4px 8px rgba(255, 255, 255, 0.05); --button-shadow-dark: 0 2px 4px rgba(255, 255, 255, 0.1); --success-color-dark: #34c759; --danger-color-dark: #ff453a;
        }
        body {
            --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --accent-color: var(--accent-color-light); --accent-hover: var(--accent-hover-light); --border-color: var(--border-color-light); --card-shadow: var(--card-shadow-light); --button-shadow: var(--button-shadow-light); --success-color: var(--success-color-light); --danger-color: var(--danger-color-light);
            font-family: var(--font-primary); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; transition: background-color 0.3s, color 0.3s; display: flex; flex-direction: column; height: 100%; overflow-x: hidden;
        }
        body.dark-mode {
            --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --accent-color: var(--accent-color-dark); --accent-hover: var(--accent-hover-dark); --border-color: var(--border-color-dark); --card-shadow: var(--card-shadow-dark); --button-shadow: var(--button-shadow-dark); --success-color: var(--success-color-dark); --danger-color: var(--danger-color-dark);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        .app-header { background-color: var(--bg-secondary); color: var(--text-primary); padding: 10px 15px; display: flex; align-items: center; box-shadow: var(--card-shadow); position: sticky; top: 0; z-index: 1050; }
        .app-header .app-title { font-size: 1.5rem; font-weight: 600; color: var(--accent-color); margin-left: 10px; }
        .app-container { display: flex; flex-grow: 1; overflow: hidden; margin-top: 60px; }
        .desktop-nav { width: 240px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; display: none; flex-shrink: 0; box-shadow: var(--card-shadow); position: fixed; top: 60px; bottom: 0; left: 0; overflow-y: auto; }
        .desktop-nav h2 { font-size: 1.5rem; color: var(--accent-color); margin-bottom: 30px; text-align: center; }
        .desktop-nav ul { list-style: none; } .desktop-nav ul li a { display: block; padding: 12px 15px; text-decoration: none; color: var(--text-secondary); border-radius: 8px; margin-bottom: 8px; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .desktop-nav ul li a:hover, .desktop-nav ul li a.active { background-color: var(--accent-color); color: white; }
        .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1000; transition: background-color 0.3s, border-color 0.3s; }
        .mobile-nav a { flex-grow: 1; text-align: center; padding: 8px 5px; text-decoration: none; color: var(--text-secondary); font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; border-radius: 8px; transition: color 0.2s, background-color 0.2s; }
        .mobile-nav a .nav-icon { font-size: 1.5rem; margin-bottom: 2px; } .mobile-nav a:hover, .mobile-nav a.active { color: var(--accent-color); }
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; padding-bottom: 80px; }
        .page { display: none; animation: fadeIn 0.5s ease-in-out; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .page-header h1 { font-size: 1.8rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; }
        .page-header h1 img.header-logo { width: 30px; height: 30px; margin-right: 10px; border-radius: 4px; }
        .button { padding: 10px 20px; font-size: 1rem; font-weight: 500; color: white; background-color: var(--accent-color); border: none; border-radius: 8px; cursor: pointer; box-shadow: var(--button-shadow); display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.2s, transform 0.1s; }
        .button:hover { background-color: var(--accent-hover); } .button:active { transform: scale(0.98); }
        .button.secondary { background-color: var(--text-secondary); color: var(--bg-secondary); } .button.secondary:hover { background-color: color-mix(in srgb, var(--text-secondary) 80%, black); }
        .button.danger { background-color: var(--danger-color); } .button.danger:hover { background-color: color-mix(in srgb, var(--danger-color) 80%, black); }
        .input-field, .textarea-field, .select-field { width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus, .textarea-field:focus, .select-field:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 30%, transparent); }
        .textarea-field { min-height: 100px; resize: vertical; } label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .card { background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--card-shadow); transition: background-color 0.3s, box-shadow 0.3s; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .text-center { text-align: center; } .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mb-3 { margin-bottom: 1.5rem; } .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; } .mt-3 { margin-top: 1.5rem; }
        #home-page .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        #home-page .summary-card { text-align: center; } #home-page .summary-card h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 8px; } #home-page .summary-card p { font-size: 2rem; font-weight: bold; color: var(--accent-color); }
        #home-page .progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 8px; height: 20px; margin-bottom: 10px; overflow: hidden; }
        #home-page .progress-bar { width: 0%; height: 100%; background-color: var(--success-color); border-radius: 8px 0 0 8px; transition: width 0.5s ease-in-out; text-align: center; color: white; font-size: 0.8rem; line-height: 20px; }
        #home-page #quick-add-form { display: flex; gap: 10px; margin-bottom: 20px; } #home-page #quick-add-input { flex-grow: 1; }
        #home-page #motivational-quote { font-style: italic; color: var(--text-secondary); padding: 15px; background-color: color-mix(in srgb, var(--accent-color) 5%, transparent); border-left: 3px solid var(--accent-color); border-radius: 0 8px 8px 0; }
        #task-list-page .filter-search-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 10px; background-color: color-mix(in srgb, var(--border-color) 30%, var(--bg-primary)); border-radius: 8px;}
        #task-list-page .filter-tabs button { padding: 8px 15px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s;} #task-list-page .filter-tabs button:hover, #task-list-page .filter-tabs button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        #task-list-page #search-task-input { flex-grow: 1; min-width: 200px; }
        .task-item-card { display: flex; align-items: flex-start; gap: 15px; cursor: grab; } .task-item-card.dragging { opacity: 0.6; background-color: color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .task-item-card .task-checkbox { margin-top: 4px; transform: scale(1.3); accent-color: var(--accent-color); cursor: pointer; }
        .task-item-card .task-content { flex-grow: 1; } .task-item-card .task-description { font-size: 1.1rem; font-weight: 500; word-break: break-word; }
        .task-item-card.completed .task-description { text-decoration: line-through; color: var(--text-secondary); }
        .task-item-card .task-meta { font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .task-item-card .task-meta .task-time { font-size: 0.8em; background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); padding: 1px 5px; border-radius: 4px; }
        .task-item-card .task-tag { background-color: color-mix(in srgb, var(--accent-color) 20%, transparent); color: var(--accent-color); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .task-tag.work { background-color: #ffc107; color: #333; } .task-tag.personal { background-color: #28a745; color: white; } .task-tag.shopping { background-color: #fd7e14; color: white; }
        .task-item-card .task-actions { margin-left: auto; display: flex; gap: 8px; } .task-item-card .task-actions button { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; padding: 5px; border-radius: 50%; }
        .task-item-card .task-actions button:hover { color: var(--accent-color); background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); } .task-item-card .task-actions .delete-btn:hover { color: var(--danger-color); background-color: color-mix(in srgb, var(--danger-color) 10%, transparent); }
        #empty-task-list { text-align: center; padding: 40px 20px; color: var(--text-secondary); } #empty-task-list p { font-size: 1.2rem; margin-top: 10px; } #empty-task-list .empty-icon { font-size: 3rem; margin-bottom: 10px; }
        #add-edit-task-page .form-group { margin-bottom: 20px; } .validation-error { color: var(--danger-color); font-size: 0.85rem; margin-top: -10px; margin-bottom: 10px; }
        #add-edit-task-page .time-input-group { display: flex; gap: 10px; align-items: center; } #add-edit-task-page #task-due-date { flex-grow: 2; } #add-edit-task-page #task-due-time { flex-grow: 1; }
        #profile-page .avatar-section { text-align: center; margin-bottom: 20px; } #profile-page .avatar-image-display { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px auto; border: 3px solid var(--border-color); background-color: var(--bg-secondary); display: none; }
        #profile-page .avatar-placeholder { width: 100px; height: 100px; background-color: var(--border-color); color: var(--text-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; margin: 0 auto 10px auto; border: 3px solid var(--border-color); }
        #settings-page .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); } #settings-page .setting-item:last-child { border-bottom: none; } #settings-page .setting-item label { margin-bottom: 0; font-weight: normal; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; } .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 28px; } .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--accent-color); } input:checked + .toggle-slider:before { transform: translateX(22px); }
        #toast-container { position: fixed; bottom: 80px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--text-primary); color: var(--bg-primary); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; font-size: 0.9rem; }
        .toast.show { opacity: 1; transform: translateY(0); } .toast.success { background-color: var(--success-color); color: white; } .toast.error { background-color: var(--danger-color); color: white; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .loader { border: 5px solid var(--bg-primary); border-top: 5px solid var(--accent-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; } 
        .loader-text { color: var(--text-primary-dark); margin-top: 10px; font-size: 0.9rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #ai-assistant-fab { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; background-color: var(--accent-color); color: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1001; transition: background-color 0.2s, transform 0.2s; font-size: 28px; line-height: 60px; text-align: center; }
        #ai-assistant-fab:hover { background-color: var(--accent-hover); transform: scale(1.1); } #ai-assistant-fab img { width: 36px; height: 36px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
        .modal-overlay.active { display: flex; }
        .ai-modal-content { background-color: var(--bg-secondary); padding: 25px; border-radius: 12px; box-shadow: var(--card-shadow); width: 100%; max-width: 500px; animation: fadeInModal 0.3s ease-out; }
        @keyframes fadeInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .ai-modal-content h2 { color: var(--accent-color); margin-top: 0; margin-bottom: 20px; text-align: center; } .ai-modal-content #ai-prompt-input { min-height: 120px; margin-bottom: 20px; } .ai-modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .hamburger-button { background: none; border: none; padding: 0; cursor: pointer; display: flex; flex-direction: column; justify-content: space-around; width: 24px; height: 20px; } .hamburger-button span { display: block; width: 100%; height: 3px; background-color: var(--text-primary); border-radius: 3px; transition: all 0.3s; }
        .hamburger-button[aria-expanded="true"] span:nth-child(1) { transform: rotate(45deg) translate(4px, 5px); } .hamburger-button[aria-expanded="true"] span:nth-child(2) { opacity: 0; } .hamburger-button[aria-expanded="true"] span:nth-child(3) { transform: rotate(-45deg) translate(3px, -4px); }
        .sidenav-container { height: 100%; width: 280px; position: fixed; z-index: 1200; top: 0; left: -290px; background-color: var(--bg-secondary); overflow-x: hidden; transition: left 0.3s ease-in-out; padding-top: 0px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .sidenav-container.active { left: 0; } .sidenav-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .sidenav-header h2 { font-size: 1.4rem; color: var(--accent-color); margin: 0; } .sidenav-close-button { background: none; border: none; font-size: 2rem; color: var(--text-secondary); cursor: pointer; padding: 0 5px; }
        .sidenav-container ul { list-style: none; padding: 15px 0; flex-grow: 1; overflow-y: auto; } .sidenav-container ul li a { padding: 12px 20px; text-decoration: none; font-size: 1rem; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 12px; transition: background-color 0.2s, color 0.2s; border-radius: 0 8px 8px 0; margin: 2px 0; }
        .sidenav-container ul li a:hover, .sidenav-container ul li a.active-sidenav-link { background-color: var(--accent-color); color: white; } .sidenav-container ul li a .nav-icon { font-size: 1.3rem; } .sidenav-container ul li a .nav-icon-img { width: 22px; height: 22px; border-radius: 4px; /* For image icons */ }
        .sidenav-divider { height: 1px; margin: 15px 20px; background-color: var(--border-color); }
        .whatsapp-icon { width: 20px; height: 20px; margin-right: 10px; vertical-align: middle; }
        .social-bar-ad-placeholder { background-color: #f0f0f0; color: #555; text-align: center; padding: 8px; font-size: 0.8em; border-top: 1px solid var(--border-color); margin-top: auto; }
        body.dark-mode .social-bar-ad-placeholder { background-color: #2a2a3e; color: #aaa; border-top: 1px solid var(--border-color-dark); }
        .sidenav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1150; display: none; opacity: 0; transition: opacity 0.3s ease-in-out; } .sidenav-overlay.active { display: block; opacity: 1; }
        #calendar-page .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #calendar-page #month-year-display { font-size: 1.5em; font-weight: 500; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; border: 1px solid var(--border-color); padding: 5px; border-radius: 8px; }
        #calendar-grid .calendar-header-cell { font-weight: bold; text-align: center; padding: 8px 0; background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); border-radius: 4px; }
        #calendar-grid .calendar-day-cell { border: 1px solid var(--border-color); min-height: 80px; padding: 5px; font-size: 0.9em; position: relative; cursor: pointer; transition: background-color 0.2s; }
        #calendar-grid .calendar-day-cell:hover { background-color: color-mix(in srgb, var(--accent-color) 5%, transparent); }
        #calendar-grid .calendar-day-cell.other-month { color: var(--text-secondary); background-color: var(--bg-primary); }
        #calendar-grid .calendar-day-cell.today { background-color: color-mix(in srgb, var(--accent-color) 20%, transparent); border: 1px solid var(--accent-color); font-weight: bold; }
        #calendar-grid .calendar-day-cell .day-number { font-weight: bold; }
        #calendar-grid .calendar-day-cell .task-on-day { font-size: 0.75em; background-color: var(--accent-color); color: white; padding: 2px 4px; border-radius: 3px; margin-top: 3px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #calendar-grid .calendar-day-cell .task-on-day.long-event { background-color: var(--success-color); }
        #add-long-event-modal .modal-content label { margin-top: 10px; }
        .ad-banner-placeholder { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #333; color: white; text-align: center; padding: 10px 0; font-size: 0.9em; z-index: 100; }
        .ad-banner-placeholder a { color: #87cefa; text-decoration: none; }
        #pomodoro-page .pomodoro-timer-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .pomodoro-circle { width: 200px; height: 200px; position: relative; margin-bottom: 20px; }
        .pomodoro-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .pomodoro-circle .progress-ring-bg { stroke: var(--border-color); fill: transparent; }
        .pomodoro-circle .progress-ring-fg { stroke: var(--accent-color); fill: transparent; transition: stroke-dashoffset 0.3s linear; }
        .pomodoro-time-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5em; font-weight: bold; color: var(--text-primary); }
        #pomodoro-status { font-size: 1.2em; font-weight: 500; color: var(--text-secondary); }
        .pomodoro-controls button { padding: 10px 20px; font-size: 1em; }
        .pomodoro-stats span { margin: 0 10px; }
        #pomodoro-usage-info { margin-top: 15px; font-size: 0.9em; color: var(--text-secondary); }
        #pomodoro-settings-modal .modal-content .form-group { margin-bottom: 15px; }
        #pomodoro-settings-modal .modal-content label { display: inline-block; width: auto; margin-right: 10px; } 
        #pomodoro-settings-modal .modal-content input[type="number"] { width: 80px; padding: 8px; display: inline-block; }
        #pomodoro-settings-modal .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0;}
        #gyansagar-ai-page .gyansagar-chat-display { height: 45vh; min-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: var(--bg-primary); display: flex; flex-direction: column; }
        .gyansagar-message { padding: 10px 15px; border-radius: 20px; margin-bottom: 12px; max-width: 80%; word-wrap: break-word; line-height: 1.45; box-shadow: var(--button-shadow); }
        .gyansagar-message.user { background-color: var(--accent-color); color: white; margin-left: auto; border-bottom-right-radius: 5px; align-self: flex-end; }
        .gyansagar-message.ai { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); margin-right: auto; border-bottom-left-radius: 5px; align-self: flex-start;}
        #gyansagar-ai-page .gyansagar-input-area { display: flex; gap: 10px; align-items: flex-end; }
        #gyansagar-ai-page #gyansagar-user-input { flex-grow: 1; min-height: 50px; resize: none; margin-bottom: 0; max-height: 150px; overflow-y: auto; }
        #gyansagar-credits-display { font-size: 0.9em; font-weight: 500; }
        #gyansagar-typing-indicator {display: none; font-style: italic; color: var(--text-secondary); padding: 8px 0; text-align: left;}
        #chat-history-list .chat-history-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        #chat-history-list .chat-history-item:last-child { border-bottom: none; }
        #chat-history-list .chat-history-item:hover { background-color: color-mix(in srgb, var(--accent-color) 5%, transparent); }
        .chat-history-item .history-item-preview { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; color: var(--text-primary); }
        .chat-history-item .history-item-date { font-size: 0.8em; color: var(--text-secondary); }
        .chat-history-item .history-message-count { font-size: 0.8em; color: var(--accent-color); margin-left: auto; }
        .chat-history-item-header { display: flex; justify-content: space-between; align-items: center; }

        @media (min-width: 768px) { .desktop-nav { display: block; margin-left:0; } .main-content { margin-left: 240px; } .hamburger-button { display: none; } #toast-container { bottom: 20px; } }
        @media (max-width: 767px) { .app-header .app-title { margin-left: 45px; } .main-content { margin-left: 0; padding: 15px; padding-bottom: 90px; } #task-list-page .filter-search-bar { flex-direction: column; } #task-list-page #search-task-input { width: 100%; } #pomodoro-settings-modal .modal-content label {width: 100%; margin-bottom: 5px;} #pomodoro-settings-modal .modal-content input[type="number"] {width: 100%;}}
    </style>
</head>
<body>
    <!-- HTML Structure -->
    <header class="app-header"> <button id="hamburger-btn" class="hamburger-button" aria-label="Open menu" aria-expanded="false"> <span></span><span></span><span></span> </button> <div class="app-title">TaskOracle AI</div> </header>
    <div class="app-container">
        <nav id="sidenav" class="sidenav-container" aria-hidden="true"> <div class="sidenav-header"> <h2>Menu</h2> <button id="sidenav-close-btn" class="sidenav-close-button" aria-label="Close menu">×</button> </div> <ul id="sidenav-links"> <li><a href="#home" class="nav-link sidenav-link" data-page="home-page"><span class="nav-icon">🏠</span> Dashboard</a></li> <li><a href="#tasks" class="nav-link sidenav-link" data-page="task-list-page"><span class="nav-icon">📋</span> Task List</a></li> <li><a href="#calendar" class="nav-link sidenav-link" data-page="calendar-page"><span class="nav-icon">📅</span> Calendar</a></li> <li><a href="#pomodoro" class="nav-link sidenav-link" data-page="pomodoro-page"><span class="nav-icon">🍅</span> Pomodoro</a></li> <li><a href="#add" class="nav-link sidenav-link" data-page="add-edit-task-page" data-action="add"><span class="nav-icon">➕</span> Add Task</a></li> <li><a href="#profile" class="nav-link sidenav-link" data-page="profile-page"><span class="nav-icon">👤</span> Profile</a></li> <li><a href="#settings" class="nav-link sidenav-link" data-page="settings-page"><span class="nav-icon">⚙️</span> Settings</a></li> <li class="sidenav-divider"></li> <li><a href="#" id="refer-on-whatsapp-btn" class="sidenav-link"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/40px-WhatsApp.svg.png" alt="WA" class="whatsapp-icon"> Refer & Earn</a> </li> <li><a href="#gyansagar" class="nav-link sidenav-link" data-page="gyansagar-ai-page"><img src="https://i.ibb.co/PQtP9g7/Gyan-Sagar-AI-logo.png" alt="GS" class="nav-icon nav-icon-img"> ज्ञान सागर AI</a></li> <li><a href="#chathistory" class="nav-link sidenav-link" data-page="chat-history-page"><span class="nav-icon">📜</span> Chat History</a></li> </ul> <div class="social-bar-ad-placeholder">Social/Ad Placeholder</div></nav>
        <div id="sidenav-overlay" class="sidenav-overlay"></div>
        <nav class="desktop-nav"> <h2>TaskCraft AI</h2> <ul> <li><a href="#home" class="nav-link" data-page="home-page"><span class="nav-icon">🏠</span> Dashboard</a></li> <li><a href="#tasks" class="nav-link" data-page="task-list-page"><span class="nav-icon">📋</span> Task List</a></li> <li><a href="#calendar" class="nav-link" data-page="calendar-page"><span class="nav-icon">📅</span> Calendar</a></li> <li><a href="#pomodoro" class="nav-link" data-page="pomodoro-page"><span class="nav-icon">🍅</span> Pomodoro</a></li> <li><a href="#add" class="nav-link" data-page="add-edit-task-page" data-action="add"><span class="nav-icon">➕</span> Add Task</a></li> <li><a href="#profile" class="nav-link" data-page="profile-page"><span class="nav-icon">👤</span> Profile</a></li> <li><a href="#settings" class="nav-link" data-page="settings-page"><span class="nav-icon">⚙️</span> Settings</a></li> </ul> </nav>
        <main class="main-content">
            <div id="home-page" class="page active"> <div class="page-header"> <h1 id="welcome-message">Welcome!</h1> </div> <div class="summary-cards"> <div class="card summary-card"> <h3>Due Today</h3> <p id="tasks-due-today">0</p> </div> <div class="card summary-card"> <h3>Completed This Week</h3> <p id="tasks-completed-week">0</p> </div> <div class="card summary-card"> <h3>Pending Tasks</h3> <p id="total-pending-tasks">0</p> </div> </div> <div class="card"> <h3>Overall Progress</h3> <div class="progress-bar-container"> <div id="overall-progress-bar" class="progress-bar">0%</div> </div> <p id="progress-text" class="text-center text-secondary">0 of 0 tasks completed</p> </div> <div class="card"> <h3>Quick Add Task</h3> <form id="quick-add-form"> <input type="text" id="quick-add-input" class="input-field" placeholder="e.g., Buy milk @groceries !today #1"> <button type="submit" class="button">⚡ Add</button> </form> </div> <div class="card"> <h3>Daily Boost</h3> <p id="motivational-quote">"The secret of getting ahead is getting started." - Mark Twain</p> </div> </div>
            <div id="task-list-page" class="page"> <div class="page-header"> <h1>Task List</h1> <button class="button nav-link add-task-from-list-btn" data-page="add-edit-task-page" data-action="add">➕ Add Task</button> </div> <div class="filter-search-bar card"> <div class="filter-tabs" id="filter-tabs-container"> <button class="filter-btn active" data-filter="all">All</button> <button class="filter-btn" data-filter="today">Today</button> <button class="filter-btn" data-filter="week">This Week</button> <button class="filter-btn" data-filter="month">This Month</button> <button class="filter-btn" data-filter="pending">Pending</button> <button class="filter-btn" data-filter="completed">Completed</button> </div> <input type="text" id="search-task-input" class="input-field" placeholder="Search tasks by keyword or @tag..."> </div> <ul id="task-list-ul" class="task-list-container"></ul> <div id="empty-task-list" class="card" style="display: none;"> <div class="empty-icon">🎉</div> <h2>All Clear!</h2> <p>You have no tasks matching this view.</p> </div> </div>
            <div id="add-edit-task-page" class="page"> <div class="page-header"> <button class="button secondary nav-link back-to-tasks-btn" data-page="task-list-page">← Back</button> <h1 id="add-edit-title">Add Task</h1> </div> <form id="task-form" class="card"> <input type="hidden" id="task-id"> <div class="form-group"> <label for="task-description">Description</label> <textarea id="task-description" class="textarea-field" required></textarea> <div class="validation-error" id="description-error"></div> </div> <div class="form-group time-input-group"> <label for="task-due-date">Due Date & Time</label> <input type="date" id="task-due-date" class="input-field"> <input type="time" id="task-due-time" class="input-field"> </div> <div class="form-group"> <label for="task-tags">Tags (comma-separated)</label> <input type="text" id="task-tags" class="input-field"> </div> <div class="form-group"> <label for="task-priority">Priority</label> <select id="task-priority" class="select-field"> <option value="3">Low</option> <option value="2" selected>Medium</option> <option value="1">High</option> </select> </div> <div class="form-actions"> <button type="button" id="cancel-task-btn" class="button secondary nav-link cancel-task-form-btn" data-page="task-list-page">Cancel</button> <button type="submit" id="save-task-btn" class="button">Save Task</button> </div> </form> </div>
            <div id="profile-page" class="page"> <div class="page-header"> <h1>User Profile</h1> </div> <form id="profile-form" class="card"> <div class="avatar-section"> <img id="avatar-image" src="#" alt="User Avatar" class="avatar-image-display"> <div id="avatar-placeholder" class="avatar-placeholder">U</div> <input type="file" id="avatar-upload-input" accept="image/*" style="display: none;"> <button type="button" id="change-avatar-btn" class="button secondary mt-1">Change Avatar</button> <p id="avatar-info" class="text-secondary mt-1" style="font-size:0.8rem;">Recommended: < 1MB</p> </div> <div class="form-group"> <label for="user-name">Name</label> <input type="text" id="user-name" class="input-field"> </div> <div class="form-group"> <label for="user-email">Email</label> <input type="email" id="user-email" class="input-field"> </div> <div class="form-actions"> <button type="submit" id="save-profile-btn" class="button">Save Profile</button> </div> </form> <div class="card mt-3"> <button type="button" id="reset-app-data-profile" class="button danger">Reset All App Data</button> <p class="text-secondary mt-1">This will delete all tasks and profile information.</p> </div> </div>
            <div id="settings-page" class="page"> <div class="page-header"> <h1>Settings</h1> </div> <div class="card"> <div class="setting-item"> <label for="dark-mode-toggle">Dark Mode</label> <label class="toggle-switch"> <input type="checkbox" id="dark-mode-toggle"> <span class="toggle-slider"></span> </label> </div> <div class="setting-item"> <label for="notifications-toggle">Enable Notifications</label> <label class="toggle-switch"> <input type="checkbox" id="notifications-toggle"> <span class="toggle-slider"></span> </label> </div> </div> <div class="card mt-3"> <h3>Data Management</h3> <button type="button" id="clear-all-tasks-btn" class="button danger mt-1">Clear All Tasks</button> <button type="button" id="reset-app-data-settings" class="button danger mt-2">Reset Entire App</button> </div> <div class="card mt-3 text-center text-secondary"> <p>TaskCraft Pro v1.6.0 (Gyan Sagar AI)</p> <p>© 2025 Your App Name.</p> </div> </div>
            <div id="calendar-page" class="page"> <div class="page-header"> <h1>📅 Calendar</h1> <button id="add-long-event-ad-btn" class="button">🌟 Add Long Event (Watch Ad)</button> </div> <div class="calendar-controls card"> <button id="prev-month-btn" class="button secondary">⬅️ Prev</button> <div id="month-year-display">Month Year</div> <button id="next-month-btn" class="button secondary">Next ➡️</button> </div> <div id="calendar-grid" class="card"></div> </div>
            <div id="pomodoro-page" class="page"> <div class="page-header"> <h1>🍅 Pomodoro Timer</h1> <button id="pomodoro-settings-btn" class="button secondary">⚙️ Settings</button> </div> <div class="card pomodoro-timer-container"> <div id="pomodoro-status" class="mb-2">Work Session</div> <div class="pomodoro-circle"> <svg viewBox="0 0 100 100"> <circle class="progress-ring-bg" cx="50" cy="50" r="45" stroke-width="10"></circle> <circle id="pomodoro-progress-ring" class="progress-ring-fg" cx="50" cy="50" r="45" stroke-width="10" stroke-dasharray="283" stroke-dashoffset="283"></circle> </svg> <div id="pomodoro-time-display" class="pomodoro-time-display">25:00</div> </div> <div class="pomodoro-controls button-group mb-2"> <button id="pomodoro-start-pause-btn" class="button">▶️ Start</button> <button id="pomodoro-reset-btn" class="button secondary">🔄 Reset</button> <button id="pomodoro-skip-break-btn" class="button secondary" style="display:none;">⏭️ Skip Break</button> </div> <div class="pomodoro-stats text-secondary"> <span>Cycles: <span id="pomodoro-cycle-count">0</span></span> <span>Today's Usage: <span id="pomodoro-daily-usage">0</span> min</span> </div> <div id="pomodoro-usage-info" class="mt-2"> Free daily usage: <span id="pomodoro-free-limit">120</span> min. <button id="pomodoro-extend-time-ad-btn" class="button small accent">Extend Time (Watch Ad)</button> </div> </div> </div>
            <!-- Gyan Sagar AI Chat Page -->
            <div id="gyansagar-ai-page" class="page">
                <div class="page-header">
                    <h1><img src="https://i.ibb.co/PQtP9g7/Gyan-Sagar-AI-logo.png" alt="GS Logo" class="header-logo">ज्ञान सागर AI</h1>
                    <div id="gyansagar-credits-display" class="text-secondary">Free Chats: 10 | Credits: 0</div>
                </div>
                <div class="card">
                    <div id="gyansagar-chat-area" class="gyansagar-chat-display">
                        <div class="gyansagar-message ai">Namaste! I am ज्ञान सागर AI. How can I assist you today?</div>
                    </div>
                    <div id="gyansagar-typing-indicator">ज्ञान सागर AI is typing...</div>
                    <div class="gyansagar-input-area mt-2">
                        <textarea id="gyansagar-user-input" class="textarea-field" placeholder="Ask any question from any subject..."></textarea>
                        <button id="gyansagar-send-btn" class="button">➡️</button>
                    </div>
                    <div id="gyansagar-ad-reward-area" style="display: none; margin-top: 15px; text-align: center;">
                        <p class="text-secondary">You've used your free chats for today.</p>
                        <button id="gyansagar-watch-ad-btn" class="button">Watch Ad for 5 More Chat Credits</button>
                    </div>
                </div>
            </div>
            <!-- Chat History Page -->
            <div id="chat-history-page" class="page">
                <div class="page-header">
                    <h1>📜 ज्ञान सागर AI - Chat History</h1>
                </div>
                <div id="chat-history-list" class="card">
                    <p id="no-chat-history-msg" class="text-secondary text-center" style="display: none;">No chat history found.</p>
                </div>
            </div>
        </main>
        <nav class="mobile-nav"> <a href="#home" class="nav-link bottom-nav-link" data-page="home-page"><span class="nav-icon">🏠</span> Dashboard</a> <a href="#tasks" class="nav-link bottom-nav-link" data-page="task-list-page"><span class="nav-icon">📋</span> Tasks</a> <a href="#add" class="nav-link bottom-nav-link" data-page="add-edit-task-page" data-action="add"><span class="nav-icon">➕</span> Add</a> <a href="#profile" class="nav-link bottom-nav-link" data-page="profile-page"><span class="nav-icon">👤</span> Profile</a> <a href="#settings" class="nav-link bottom-nav-link" data-page="settings-page"><span class="nav-icon">⚙️</span> Settings</a> </nav>
    </div>
    <div id="ai-assistant-fab" title="AI Task Creator"> <img src="https://storage.googleapis.com/grounded-prd/console/experiments/RAG/images/94f4cf57-a41b-4752-8d57-0a899468c88f.png" alt="AI"> </div>
    <div id="ai-assistant-modal-overlay" class="modal-overlay"> <div class="ai-modal-content"> <h2>🤖 AI Task Creator</h2> <p class="text-secondary mb-2">Describe tasks or ask for a long-term plan...</p> <textarea id="ai-prompt-input" class="textarea-field" placeholder="Enter prompt..."></textarea> <div class="ai-modal-actions"> <button type="button" id="ai-modal-close-btn" class="button secondary">Close</button> <button type="button" id="ai-generate-tasks-btn" class="button">✨ Generate Tasks</button> <button type="button" id="ai-long-plan-ad-btn" class="button">🗓️ Long Plan (Ad)</button> </div> </div> </div>
    <div id="add-long-event-modal" class="modal-overlay"> <div class="ai-modal-content"> <h2>🗓️ Add Long Event/Vacation</h2> <div class="form-group"> <label for="long-event-desc">Description</label> <input type="text" id="long-event-desc" class="input-field"> </div> <div class="form-group"> <label for="long-event-start">Start Date</label> <input type="date" id="long-event-start" class="input-field"> </div> <div class="form-group"> <label for="long-event-end">End Date</label> <input type="date" id="long-event-end" class="input-field"> </div> <div class="ai-modal-actions"> <button type="button" id="long-event-modal-close-btn" class="button secondary">Cancel</button> <button type="button" id="long-event-save-btn" class="button">Save Event</button> </div> </div> </div>
    <div id="pomodoro-settings-modal" class="modal-overlay"> <div class="ai-modal-content"> <h2>🍅 Pomodoro Settings</h2> <div class="form-group"> <label for="pomodoro-work-duration">Work Duration (min):</label> <input type="number" id="pomodoro-work-duration" class="input-field" min="1" value="25"> </div> <div class="form-group"> <label for="pomodoro-short-break-duration">Short Break (min):</label> <input type="number" id="pomodoro-short-break-duration" class="input-field" min="1" value="5"> </div> <div class="form-group"> <label for="pomodoro-long-break-duration">Long Break (min):</label> <input type="number" id="pomodoro-long-break-duration" class="input-field" min="1" value="15"> </div> <div class="form-group"> <label for="pomodoro-long-break-interval">Long Break After (cycles):</label> <input type="number" id="pomodoro-long-break-interval" class="input-field" min="1" value="4"> </div> <div class="setting-item"> <label for="pomodoro-auto-start">Auto-start next session:</label> <label class="toggle-switch"> <input type="checkbox" id="pomodoro-auto-start" checked> <span class="toggle-slider"></span> </label> </div> <div class="setting-item"> <label for="pomodoro-sound-toggle">Sound Notification:</label> <label class="toggle-switch"> <input type="checkbox" id="pomodoro-sound-toggle" checked> <span class="toggle-slider"></span> </label> </div> <div class="ai-modal-actions"> <button type="button" id="pomodoro-settings-close-btn" class="button secondary">Close</button> <button type="button" id="pomodoro-settings-save-btn" class="button">Save Settings</button> </div> </div> </div>
    <div id="toast-container"></div>
    <div class="loader-overlay" id="loader-overlay"><div class="loader"></div><div class="loader-text"></div></div>
    <div class="ad-banner-placeholder">Banner Ad Placeholder</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded. Initializing app v1.6.0 (Gyan Sagar AI)");

        const GEMINI_API_KEY = "AIzaSyDdsi34hl_PkZE92TUqwFxuPOdxmn638xo"; // YOUR ACTUAL KEY
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        
        const mainContent = document.querySelector('.main-content');
        const allNavLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page'); 
        const loaderOverlay = document.getElementById('loader-overlay');
        const welcomeMessage = document.getElementById('welcome-message');
        const tasksDueTodayEl = document.getElementById('tasks-due-today');
        const tasksCompletedWeekEl = document.getElementById('tasks-completed-week');
        const totalPendingTasksEl = document.getElementById('total-pending-tasks');
        const overallProgressBar = document.getElementById('overall-progress-bar');
        const progressTextEl = document.getElementById('progress-text');
        const quickAddForm = document.getElementById('quick-add-form');
        const quickAddInput = document.getElementById('quick-add-input');
        const motivationalQuoteEl = document.getElementById('motivational-quote');
        const taskListUl = document.getElementById('task-list-ul');
        const filterTabsContainer = document.getElementById('filter-tabs-container');
        const searchTaskInput = document.getElementById('search-task-input');
        const emptyTaskListMessage = document.getElementById('empty-task-list');
        const taskForm = document.getElementById('task-form');
        const addEditTitle = document.getElementById('add-edit-title');
        const taskIdInput = document.getElementById('task-id');
        const taskDescriptionInput = document.getElementById('task-description');
        const taskDueDateInput = document.getElementById('task-due-date');
        const taskDueTimeInput = document.getElementById('task-due-time');
        const taskTagsInput = document.getElementById('task-tags');
        const taskPriorityInput = document.getElementById('task-priority');
        const descriptionError = document.getElementById('description-error');
        const profileForm = document.getElementById('profile-form');
        const avatarImage = document.getElementById('avatar-image');
        const avatarPlaceholder = document.getElementById('avatar-placeholder');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const userNameInput = document.getElementById('user-name');
        const userEmailInput = document.getElementById('user-email');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const notificationsToggle = document.getElementById('notifications-toggle');
        const clearAllTasksBtn = document.getElementById('clear-all-tasks-btn');
        const resetAppDataProfileBtn = document.getElementById('reset-app-data-profile');
        const resetAppDataSettingsBtn = document.getElementById('reset-app-data-settings');
        const aiAssistantFab = document.getElementById('ai-assistant-fab');
        const aiAssistantModalOverlay = document.getElementById('ai-assistant-modal-overlay');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
        const aiGenerateTasksBtn = document.getElementById('ai-generate-tasks-btn');
        const aiLongPlanAdBtn = document.getElementById('ai-long-plan-ad-btn');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidenav = document.getElementById('sidenav');
        const sidenavCloseBtn = document.getElementById('sidenav-close-btn');
        const sidenavOverlay = document.getElementById('sidenav-overlay');
        const referOnWhatsAppBtn = document.getElementById('refer-on-whatsapp-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const addLongEventAdBtn = document.getElementById('add-long-event-ad-btn');
        const addLongEventModal = document.getElementById('add-long-event-modal');
        const longEventDescInput = document.getElementById('long-event-desc');
        const longEventStartInput = document.getElementById('long-event-start');
        const longEventEndInput = document.getElementById('long-event-end');
        const longEventModalCloseBtn = document.getElementById('long-event-modal-close-btn');
        const longEventSaveBtn = document.getElementById('long-event-save-btn');
        const pomodoroTimeDisplay = document.getElementById('pomodoro-time-display');
        const pomodoroProgressRing = document.getElementById('pomodoro-progress-ring');
        const pomodoroStatusEl = document.getElementById('pomodoro-status');
        const pomodoroStartPauseBtn = document.getElementById('pomodoro-start-pause-btn');
        const pomodoroResetBtn = document.getElementById('pomodoro-reset-btn');
        const pomodoroSkipBreakBtn = document.getElementById('pomodoro-skip-break-btn');
        const pomodoroCycleCountEl = document.getElementById('pomodoro-cycle-count');
        const pomodoroDailyUsageEl = document.getElementById('pomodoro-daily-usage');
        const pomodoroFreeLimitEl = document.getElementById('pomodoro-free-limit');
        const pomodoroExtendTimeAdBtn = document.getElementById('pomodoro-extend-time-ad-btn');
        const pomodoroSettingsBtn = document.getElementById('pomodoro-settings-btn');
        const pomodoroSettingsModal = document.getElementById('pomodoro-settings-modal');
        const pomodoroWorkDurationInput = document.getElementById('pomodoro-work-duration');
        const pomodoroShortBreakDurationInput = document.getElementById('pomodoro-short-break-duration');
        const pomodoroLongBreakDurationInput = document.getElementById('pomodoro-long-break-duration');
        const pomodoroLongBreakIntervalInput = document.getElementById('pomodoro-long-break-interval');
        const pomodoroAutoStartToggle = document.getElementById('pomodoro-auto-start');
        const pomodoroSoundToggle = document.getElementById('pomodoro-sound-toggle');
        const pomodoroSettingsCloseBtn = document.getElementById('pomodoro-settings-close-btn');
        const pomodoroSettingsSaveBtn = document.getElementById('pomodoro-settings-save-btn');
        
        // Gyan Sagar AI Elements
        const gyanSagarChatArea = document.getElementById('gyansagar-chat-area');
        const gyanSagarUserInput = document.getElementById('gyansagar-user-input');
        const gyanSagarSendBtn = document.getElementById('gyansagar-send-btn');
        const gyanSagarCreditsDisplay = document.getElementById('gyansagar-credits-display');
        const gyanSagarAdRewardArea = document.getElementById('gyansagar-ad-reward-area');
        const gyanSagarWatchAdBtn = document.getElementById('gyansagar-watch-ad-btn');
        const gyanSagarTypingIndicator = document.getElementById('gyansagar-typing-indicator');
        const chatHistoryListEl = document.getElementById('chat-history-list');
        const noChatHistoryMsg = document.getElementById('no-chat-history-msg');
        
        let currentCalendarDate = new Date();
        
        let tasks = [];
        let userProfile = { name: '', email: '', avatarChar: 'U', avatarDataUrl: null, referralCode: null };
        let appSettings = { 
            darkMode: false, 
            notificationsEnabled: false, 
            longPlannerUnlockedUntil: 0, 
            aiLongPlanQuota: 0,
            pomodoro: {
                workDuration: 25, shortBreak: 5, longBreak: 15, longBreakInterval: 4,
                autoStart: true, soundEnabled: true, dailyUsageMinutes: 0, dailyLimitMinutes: 120, 
                lastUsageResetDate: new Date().toISOString().split('T')[0] 
            },
            gyanSagar: { 
                dailyFreeChatsUsed: 0,
                lastFreeChatResetDate: new Date().toISOString().split('T')[0],
                credits: 0,
                chatHistory: [] 
            }
        };
        let currentFilter = 'all'; let currentSearchTerm = ''; let editingTaskId = null; let draggedItem = null;
        const motivationalQuotes = [ "The secret of getting ahead is getting started.", "The best way to predict the future is to create it." ];
        let pomodoroIntervalId = null;
        let pomodoroTimeRemaining = (appSettings.pomodoro?.workDuration || 25) * 60;
        let pomodoroCurrentSession = 'work'; 
        let pomodoroCyclesCompleted = 0;
        let pomodoroIsRunning = false;
        const pomodoroRingCircumference = 2 * Math.PI * 45; 
        let currentGyanSagarChatSession = []; 
        let currentChatSessionId = null; 

        const showLoader = (message = '') => { if(loaderOverlay) { loaderOverlay.style.display = 'flex'; const lt = loaderOverlay.querySelector('.loader-text'); if (lt) lt.textContent = message;}};
        const hideLoader = () => { if(loaderOverlay) { loaderOverlay.style.display = 'none'; const lt = loaderOverlay.querySelector('.loader-text'); if(lt) lt.textContent = '';}};
        const showToast = (message, type = 'info') => { const tc=document.getElementById('toast-container'); if(!tc)return; const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=message; tc.appendChild(t); void t.offsetWidth; t.classList.add('show'); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),300);},3000);};
        const saveData = () => { try { localStorage.setItem('TC_tasks',JSON.stringify(tasks)); localStorage.setItem('TC_userProfile',JSON.stringify(userProfile)); localStorage.setItem('TC_appSettings',JSON.stringify(appSettings)); console.log("Data saved."); } catch(e){ console.error("Save error:",e); showToast("Error saving.","error");}};
        const loadData = () => { try { const st=localStorage.getItem('TC_tasks'); const sp=localStorage.getItem('TC_userProfile'); const ss=localStorage.getItem('TC_appSettings'); if(st)tasks=JSON.parse(st); if(sp)userProfile=JSON.parse(sp); if(ss){const loadedSettings=JSON.parse(ss);appSettings={...appSettings,...loadedSettings}; if(!appSettings.pomodoro){appSettings.pomodoro={workDuration:25,shortBreak:5,longBreak:15,longBreakInterval:4,autoStart:true,soundEnabled:true,dailyUsageMinutes:0,dailyLimitMinutes:120,lastUsageResetDate:new Date().toISOString().split('T')[0]};} if(!appSettings.gyanSagar){appSettings.gyanSagar={dailyFreeChatsUsed:0,lastFreeChatResetDate:new Date().toISOString().split('T')[0],credits:0,chatHistory:[]};}else{appSettings.gyanSagar.dailyFreeChatsUsed=appSettings.gyanSagar.dailyFreeChatsUsed||0;appSettings.gyanSagar.lastFreeChatResetDate=appSettings.gyanSagar.lastFreeChatResetDate||new Date().toISOString().split('T')[0];appSettings.gyanSagar.credits=appSettings.gyanSagar.credits||0;appSettings.gyanSagar.chatHistory=Array.isArray(appSettings.gyanSagar.chatHistory)?appSettings.gyanSagar.chatHistory:[];}}else{appSettings.pomodoro.lastUsageResetDate=new Date().toISOString().split('T')[0];appSettings.gyanSagar={dailyFreeChatsUsed:0,lastFreeChatResetDate:new Date().toISOString().split('T')[0],credits:0,chatHistory:[]};}pomodoroTimeRemaining=(appSettings.pomodoro?.workDuration||25)*60;console.log("Data loaded.");}catch(e){console.error("Load error:",e);tasks=[];userProfile={name:'',email:'',avatarChar:'U',avatarDataUrl:null,referralCode:null};appSettings={darkMode:false,notificationsEnabled:false,longPlannerUnlockedUntil:0,aiLongPlanQuota:0,pomodoro:{workDuration:25,shortBreak:5,longBreak:15,longBreakInterval:4,autoStart:true,soundEnabled:true,dailyUsageMinutes:0,dailyLimitMinutes:120,lastUsageResetDate:new Date().toISOString().split('T')[0]},gyanSagar:{dailyFreeChatsUsed:0,lastFreeChatResetDate:new Date().toISOString().split('T')[0],credits:0,chatHistory:[]}};showToast("Error loading. Defaults used.","error");}};

        const renderAll = () => { if(typeof renderTaskList==="function")renderTaskList();if(typeof updateDashboard==="function")updateDashboard();if(typeof updateProfileDisplay==="function")updateProfileDisplay();if(typeof applySettings==="function")applySettings();if(typeof renderCalendar==="function"&&document.getElementById('calendar-page')?.classList.contains('active')){renderCalendar(currentCalendarDate.getFullYear(),currentCalendarDate.getMonth());}if(typeof updatePomodoroUI==="function"&&document.getElementById('pomodoro-page')?.classList.contains('active')){updatePomodoroUI();}if(typeof updateGyanSagarCreditsDisplay==="function"&&document.getElementById('gyansagar-ai-page')?.classList.contains('active')){updateGyanSagarCreditsDisplay();} console.log("renderAll called");};
        
        const originalShowPage = (pageId) => { console.log("Original showPage for:", pageId); if(!pageId){console.error("showPage: no pageId");return;} showLoader();pages.forEach(page=>page.classList.remove('active'));const targetPage=document.getElementById(pageId);if(targetPage){targetPage.classList.add('active');if(mainContent)mainContent.scrollTop=0;if(pageId==='calendar-page'&&typeof renderCalendar==='function')renderCalendar(currentCalendarDate.getFullYear(),currentCalendarDate.getMonth());if(pageId==='pomodoro-page'&&typeof updatePomodoroUI==='function'){resetPomodoroDailyUsageIfNeeded();updatePomodoroUI();}if(pageId==='gyansagar-ai-page'&&typeof updateGyanSagarCreditsDisplay==='function'){resetGyanSagarDailyFreeChats();updateGyanSagarCreditsDisplay();}}else{console.error(`Page "${pageId}" not found.`);const home=document.getElementById('home-page');if(home)home.classList.add('active');} allNavLinks.forEach(link=>{link.classList.remove('active','active-sidenav-link');if(link.dataset.page===pageId){link.classList.add('active');if(link.classList.contains('sidenav-link')){link.classList.add('active-sidenav-link');}}});const hash=pageId.replace('-page','');if(window.location.hash!==`#${hash}`){try{window.history.pushState(null,'',`#${hash}`);}catch(e){console.warn("Could not update hash:",e)}} setTimeout(hideLoader,50);};
        showPage = (pageId) => { 
            if (pageId === 'gyansagar-ai-page') {
                const previousPageActive = document.querySelector('.page.active');
                // Check if we are NOT coming from chat history or if no specific session is active
                const isNavigatingDirectlyOrNoActiveSession = (!previousPageActive || previousPageActive.id !== 'chat-history-page') && !currentChatSessionId;

                if(isNavigatingDirectlyOrNoActiveSession) {
                    currentGyanSagarChatSession = []; // Start a new chat session
                    currentChatSessionId = null;      // Clear any previous session ID
                    if (gyanSagarChatArea) gyanSagarChatArea.innerHTML = ''; 
                    addMessageToGyanSagarChat("Namaste! I am ज्ञान सागर AI. How can I assist you today?", 'ai', false); // Add initial greeting without saving it to history yet
                }
            }
            if (pageId === 'chat-history-page' && typeof renderChatHistory === 'function') {
                renderChatHistory();
            }
            originalShowPage(pageId); // Call the original showPage logic
        };

        const applyTheme = () => { if(!darkModeToggle)return; if(appSettings.darkMode){document.body.classList.add('dark-mode');darkModeToggle.checked=true;}else{document.body.classList.remove('dark-mode');darkModeToggle.checked=false;}};
        const applyNotificationSetting = () => { if(!notificationsToggle)return; notificationsToggle.checked=appSettings.notificationsEnabled; if(appSettings.notificationsEnabled&&'Notification'in window&&Notification.permission!=='granted'&&Notification.permission!=='denied'){Notification.requestPermission().then(p=>{if(p==='denied'){appSettings.notificationsEnabled=false;notificationsToggle.checked=false;saveData();}});}};
        function sendNotification(title, body) { if(!appSettings.notificationsEnabled||!('Notification'in window)||Notification.permission!=='granted')return;new Notification(title,{body});}
        function createTaskObjectFromInput(description, dueDateStr = null, dueTimeStr = null, tagsArray = [], priorityStr = '2', isLongEvent = false, endDateStr = null) { const task = { id: Date.now() + Math.random(), description: description.trim(), dueDate: null, dueTime: null, completed: false, priority: priorityStr || '2', tags: Array.isArray(tagsArray) ? tagsArray : [], createdAt: Date.now(), completedAt: null, isLongEvent: isLongEvent, endDate: null }; if (dueDateStr) { let ds = String(dueDateStr).toLowerCase(); const t = new Date(); if (ds==='today') task.dueDate=t.toISOString().split('T')[0]; else if (ds==='tomorrow') { const tm=new Date(t); tm.setDate(t.getDate()+1); task.dueDate=tm.toISOString().split('T')[0];} else if (ds==='nextweek'||ds==='next week') {const nw=new Date(t); nw.setDate(t.getDate()+7); task.dueDate=nw.toISOString().split('T')[0];} else if (/^\d{4}-\d{2}-\d{2}$/.test(ds)) task.dueDate=ds; else {try{const pd=new Date(dueDateStr); if(!isNaN(pd.valueOf()))task.dueDate=pd.toISOString().split('T')[0];}catch(e){}}} if (dueTimeStr && /^\d{2}:\d{2}$/.test(dueTimeStr)) task.dueTime = dueTimeStr; if (isLongEvent && endDateStr) { let eds=String(endDateStr).toLowerCase();if(/^\d{4}-\d{2}-\d{2}$/.test(eds))task.endDate=eds;else{try{const ped=new Date(endDateStr);if(!isNaN(ped.valueOf()))task.endDate=ped.toISOString().split('T')[0];}catch(e){}}} return task; }
        function parseQuickAddString(inputString) { let ts=inputString;let dd=null;let dt=null;let tgs=[];let p='2';const ddm=ts.match(/!(\d{4}-\d{2}-\d{2}|today|tomorrow|next week|nextweek)(?:\s*@\s*(\d{1,2}:\d{2}(?:\s*[ap]m)?))?/i);if(ddm){dd=ddm[1];if(ddm[2]){let tp=ddm[2].trim().toLowerCase();const tm=tp.match(/^(\d{1,2}):(\d{2})(?:\s*([ap]m))?$/);if(tm){let h=parseInt(tm[1]);const min=tm[2];const ampm=tm[3];if(ampm==='pm'&&h<12)h+=12;if(ampm==='am'&&h===12)h=0;dt=`${String(h).padStart(2,'0')}:${min}`;}}ts=ts.replace(ddm[0],'').trim();}const trg=/@([\w-]+)/g;let m;while((m=trg.exec(ts))!==null){tgs.push(m[1].toLowerCase());}ts=ts.replace(trg,'').trim();const prm=ts.match(/#([1-3])/);if(prm){p=prm[1];ts=ts.replace(prm[0],'').trim();}const dsc=ts.trim();if(!dsc)return null;return createTaskObjectFromInput(dsc,dd,dt,tgs,p);}
        const updateDashboard = () => { if(welcomeMessage)welcomeMessage.textContent=userProfile.name?`Welcome, ${userProfile.name}!`:'Welcome!';if(tasksDueTodayEl&&tasksCompletedWeekEl&&totalPendingTasksEl&&overallProgressBar&&progressTextEl&&motivationalQuoteEl){const today=new Date().toISOString().split('T')[0];const oneWeekAgo=new Date();oneWeekAgo.setDate(oneWeekAgo.getDate()-7);tasksDueTodayEl.textContent=tasks.filter(t=>!t.completed&&t.dueDate===today).length;tasksCompletedWeekEl.textContent=tasks.filter(t=>t.completed&&t.completedAt&&new Date(t.completedAt)>=oneWeekAgo).length;totalPendingTasksEl.textContent=tasks.filter(t=>!t.completed).length;const total=tasks.length;const completed=tasks.filter(t=>t.completed).length;const progress=total>0?Math.round((completed/total)*100):0;overallProgressBar.style.width=`${progress}%`;overallProgressBar.textContent=`${progress}%`;progressTextEl.textContent=`${completed} of ${total} tasks completed.`;motivationalQuoteEl.textContent=motivationalQuotes[Math.floor(Math.random()*motivationalQuotes.length)];}console.log("Dashboard updated");};
        function getFilteredAndSortedTasks() { let f=[...tasks];const ts=new Date().toISOString().split('T')[0];const ws=new Date();ws.setHours(0,0,0,0);ws.setDate(ws.getDate()-ws.getDay()+(ws.getDay()===0?-6:1));const we=new Date(ws);we.setDate(ws.getDate()+6);we.setHours(23,59,59,999);const ms=new Date(new Date().getFullYear(),new Date().getMonth(),1);const me=new Date(new Date().getFullYear(),new Date().getMonth()+1,0);me.setHours(23,59,59,999);switch(currentFilter){case 'today':f=f.filter(t=>t.dueDate===ts&&!t.completed);break;case 'week':f=f.filter(t=>{if(!t.dueDate)return false;const td=new Date(t.dueDate+'T00:00:00Z');return td>=ws&&td<=we&&!t.completed;});break;case 'month':f=f.filter(t=>{if(!t.dueDate)return false;const td=new Date(t.dueDate+'T00:00:00Z');return td>=ms&&td<=me&&!t.completed;});break;case 'pending':f=f.filter(t=>!t.completed);break;case 'completed':f=f.filter(t=>t.completed);break;}if(currentSearchTerm){const term=currentSearchTerm.toLowerCase();f=f.filter(tk=>tk.description.toLowerCase().includes(term)||(tk.tags&&tk.tags.some(tag=>tag.toLowerCase().includes(term))));}f.sort((a,b)=>{if(a.completed!==b.completed)return a.completed?1:-1;if(parseInt(a.priority)!==parseInt(b.priority))return parseInt(a.priority)-parseInt(b.priority);const dA=a.dueDate?(a.dueTime?new Date(`${a.dueDate}T${a.dueTime}`):new Date(a.dueDate+'T00:00:00Z')):null;const dB=b.dueDate?(b.dueTime?new Date(`${b.dueDate}T${b.dueTime}`):new Date(b.dueDate+'T00:00:00Z')):null;if(dA&&dB)return dA-dB;if(dA)return -1;if(dB)return 1;return new Date(b.createdAt)-new Date(a.createdAt);});return f;}
        const renderTaskList = () => { if(!taskListUl||!emptyTaskListMessage){console.error("Task list UI missing");return;}taskListUl.innerHTML='';const tasksToRender=getFilteredAndSortedTasks();if(tasksToRender.length===0){emptyTaskListMessage.style.display='block';taskListUl.style.display='none';}else{emptyTaskListMessage.style.display='none';taskListUl.style.display='block';tasksToRender.forEach(task=>{const card=document.createElement('li');card.className=`card task-item-card ${task.completed?'completed':''} ${task.isLongEvent?'long-event-card':''}`;card.setAttribute('draggable',true);card.dataset.id=task.id;let ts='';if(task.tags&&task.tags.length){ts=task.tags.map(tag=>{let tc='';if(['work','project','meeting'].includes(tag))tc='work';else if(['personal','home','errand'].includes(tag))tc='personal';else if(['shopping','buy'].includes(tag))tc='shopping';return `<span class="task-tag ${tc}">${tag}</span>`;}).join('');}let ddt='';if(task.dueDate){try{ddt=`<span>📅 Due: ${new Date(task.dueDate+'T00:00:00').toLocaleDateString()}`;if(task.dueTime){const[h,m]=task.dueTime.split(':');const d=new Date();d.setHours(h,m);timeString=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});ddt+=` <span class="task-time">🕒 ${timeString}</span>`;}ddt+=`</span>`;}catch(e){console.warn("Date format error",task,e);ddt=`<span>📅 Due: ${task.dueDate}</span>`;}}if(task.isLongEvent&&task.endDate){ddt+=` (Ends: ${new Date(task.endDate+'T00:00:00').toLocaleDateString()})`;}card.innerHTML=`<input type="checkbox" class="task-checkbox" ${task.completed?'checked':''} data-id="${task.id}"><div class="task-content"><p class="task-description">${task.description}</p><div class="task-meta">${ddt} ${ts} <span>⭐ Priority: ${task.priority==='1'?'High':task.priority==='2'?'Medium':'Low'}</span></div></div><div class="task-actions"><button class="edit-btn" data-id="${task.id}" title="Edit">✏️</button><button class="delete-btn" data-id="${task.id}" title="Delete">🗑️</button></div>`;taskListUl.appendChild(card);});}if(typeof addDragAndDropListeners==="function")addDragAndDropListeners();console.log("Task list rendered");};
        function addDragAndDropListeners(){const ti=taskListUl.querySelectorAll('.task-item-card');ti.forEach(i=>{i.addEventListener('dragstart',handleDragStart);i.addEventListener('dragover',handleDragOver);i.addEventListener('drop',handleDrop);i.addEventListener('dragend',handleDragEnd);});}
        function handleDragStart(e){draggedItem=e.target.closest('.task-item-card');if(draggedItem){e.dataTransfer.setData('text/plain',draggedItem.dataset.id);setTimeout(()=>draggedItem.classList.add('dragging'),0);}}
        function handleDragOver(e){e.preventDefault();}
        function handleDrop(e){e.preventDefault();const ti=e.target.closest('.task-item-card');if(ti&&draggedItem&&ti!==draggedItem){const dId=parseFloat(draggedItem.dataset.id);const tId=parseFloat(ti.dataset.id);const dIdx=tasks.findIndex(t=>t.id===dId);const tIdx=tasks.findIndex(t=>t.id===tId);if(dIdx!==-1&&tIdx!==-1){const[rm]=tasks.splice(dIdx,1);tasks.splice(tIdx,0,rm);saveData();renderTaskList();showToast('Task reordered.');}}if(draggedItem)draggedItem.classList.remove('dragging');}
        function handleDragEnd(){if(draggedItem)draggedItem.classList.remove('dragging');draggedItem=null;}
        function toggleTaskComplete(id){const t=tasks.find(tk=>tk.id===id);if(t){t.completed=!t.completed;t.completedAt=t.completed?Date.now():null;saveData();renderAll();showToast(t.completed?'Task complete!':'Task pending.');if(t.completed)sendNotification('Task Completed!',t.description);}}
        function deleteTask(id){if(confirm('Delete this task?')){const idx=tasks.findIndex(t=>t.id===id);if(idx>-1){const dt=tasks.splice(idx,1)[0];saveData();renderAll();showToast(`Task "${dt.description.substring(0,20)}..." deleted.`,'success');}}}
        const prepareTaskForm=(idToEdit=null)=>{if(!taskForm||!addEditTitle||!taskIdInput||!taskDescriptionInput||!taskDueDateInput||!taskDueTimeInput||!taskTagsInput||!taskPriorityInput||!descriptionError){console.error("Task form UI missing");return;}taskForm.reset();descriptionError.textContent='';taskIdInput.value='';taskDueTimeInput.value='';if(idToEdit){editingTaskId=idToEdit;const t=tasks.find(tk=>tk.id===idToEdit);if(t){addEditTitle.textContent='Edit Task';taskIdInput.value=t.id;taskDescriptionInput.value=t.description;taskDueDateInput.value=t.dueDate||'';taskDueTimeInput.value=t.dueTime||'';taskTagsInput.value=t.tags?t.tags.join(', '):'';taskPriorityInput.value=t.priority||'2';}}else{editingTaskId=null;addEditTitle.textContent='Add New Task';taskPriorityInput.value='2';}taskDescriptionInput.focus();console.log("Task form prepared for:",editingTaskId?`edit (ID: ${editingTaskId})`:"new task");};
        const updateProfileDisplay=()=>{if(!userNameInput||!userEmailInput||!avatarImage||!avatarPlaceholder)return;userNameInput.value=userProfile.name||'';userEmailInput.value=userProfile.email||'';if(userProfile.avatarDataUrl){avatarImage.src=userProfile.avatarDataUrl;avatarImage.style.display='block';avatarPlaceholder.style.display='none';}else{avatarImage.style.display='none';avatarPlaceholder.style.display='block';avatarPlaceholder.textContent=userProfile.name?userProfile.name.charAt(0).toUpperCase():(userProfile.avatarChar||'U');}if(welcomeMessage)welcomeMessage.textContent=userProfile.name?`Welcome, ${userProfile.name}!`:'Welcome!';console.log("Profile display updated");};
        const applySettings=()=>{if(typeof applyTheme==="function")applyTheme();if(typeof applyNotificationSetting==="function")applyNotificationSetting();console.log("Settings applied");};
        function toggleSidenav(show){if(!sidenav||!hamburgerBtn||!sidenavOverlay){console.error("Sidenav elements missing.");return;}const isActive=sidenav.classList.contains('active');if(show===true||(show===undefined&&!isActive)){sidenav.classList.add('active');hamburgerBtn.setAttribute('aria-expanded','true');sidenav.setAttribute('aria-hidden','false');sidenavOverlay.classList.add('active');document.body.style.overflow='hidden';}else if(show===false||(show===undefined&&isActive)){sidenav.classList.remove('active');hamburgerBtn.setAttribute('aria-expanded','false');sidenav.setAttribute('aria-hidden','true');sidenavOverlay.classList.remove('active');document.body.style.overflow='';}}
        function generateReferralCode(length=8){const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';let result='';for(let i=0;i<length;i++)result+=chars.charAt(Math.floor(Math.random()*chars.length));return result;}
        function getOrSetUserReferralCode(){if(!userProfile.referralCode){userProfile.referralCode=generateReferralCode();saveData();}return userProfile.referralCode;}
        async function handleAIGenerateTasks(isLongPlanRequest = false) { if (!aiPromptInput) { console.error("AI prompt input missing"); return; } const userInput = aiPromptInput.value.trim(); if (!userInput) { showToast("Please enter AI prompt.", "error"); return; } if (!GEMINI_API_KEY || GEMINI_API_KEY.length < 35) { showToast("AI API Key invalid.", "error"); console.error("AI Key check failed. Key:", GEMINI_API_KEY ? GEMINI_API_KEY.substring(0,5)+"..." : "EMPTY"); return; } showLoader(isLongPlanRequest ? "Generating Long Plan..." : "Generating Tasks..."); if(aiGenerateTasksBtn) aiGenerateTasksBtn.disabled = true; if(aiLongPlanAdBtn) aiLongPlanAdBtn.disabled = true; if(aiGenerateTasksBtn) aiGenerateTasksBtn.textContent = "Thinking..."; let systemPrompt = `You are a helpful to-do list assistant. Parse the user request and generate a JSON array of task objects. Each object MUST have 'description'. Optional: 'dueDate' (YYYY-MM-DD, or 'today', 'tomorrow', 'next week'), 'dueTime' (HH:MM format, 24-hour), 'tags' (array), 'priority' ('1'-High, '2'-Med, '3'-Low, default '2'). Respond ONLY with the JSON array. Example: [{"description": "Buy milk", "dueDate": "today", "dueTime": "17:00"}]. If no tasks, return [].`; if (isLongPlanRequest) { systemPrompt = `You are an expert long-term planner. User wants a plan. Generate a JSON array of task objects. Each task: 'description', specific 'dueDate' (YYYY-MM-DD). Optional 'dueTime' (HH:MM). Infer start/end dates. Break goals into smaller, actionable steps with dates. Respond ONLY with JSON array. Example for "2 day trip to Paris next month starting 15th": [{"description":"Travel to Paris","dueDate":"YYYY-MM-15"},{"description":"Eiffel Tower","dueDate":"YYYY-MM-15","dueTime":"14:00"}]. Adjust YYYY-MM based on current date and "next month".`;} systemPrompt += ` User request: "${userInput}"`; try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] }) }); if (!response.ok) { const errText = await response.text(); console.error("AI API Raw Error:", errText); let errMessage = `AI API Error: ${response.status}`; try { const errData = JSON.parse(errText); errMessage += ` ${errData.error?.message || ''}`; } catch(e) { errMessage += ` - ${errText.substring(0,150)}`;} throw new Error(errMessage); } const data = await response.json(); let aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]'; aiResponseText = aiResponseText.replace(/^```json\s*|```\s*$/g, '').trim(); let parsedTasksAI; try { parsedTasksAI = JSON.parse(aiResponseText); } catch (jsonError) { console.error("AI JSON parse error:", jsonError, "Raw:", aiResponseText); showToast("AI format error.", "error"); parsedTasksAI = []; } if (Array.isArray(parsedTasksAI) && parsedTasksAI.length > 0) { let count = 0; parsedTasksAI.forEach(aiTask => { if (aiTask && typeof aiTask.description === 'string' && aiTask.description.trim() !== '') { tasks.push(createTaskObjectFromInput(aiTask.description, aiTask.dueDate, aiTask.dueTime, aiTask.tags, aiTask.priority, isLongPlanRequest && (aiTask.endDate || (aiTask.duration && parseInt(aiTask.duration) > 1)), aiTask.endDate)); count++; }}); if (count > 0) { saveData(); renderAll(); showToast(`${count} tasks by AI${isLongPlanRequest?' for long plan':''}!`, 'success'); if(aiPromptInput) aiPromptInput.value = ''; if(aiAssistantModalOverlay) aiAssistantModalOverlay.classList.remove('active'); if(isLongPlanRequest) { appSettings.aiLongPlanQuota = Math.max(0, (appSettings.aiLongPlanQuota || 0) -1); saveData();} } else { showToast("AI items not converted to tasks.", "info"); } } else { showToast("AI found no tasks.", "info"); } } catch (error) { console.error("Error with AI:", error); showToast(`AI Error: ${error.message}`, "error"); } finally { hideLoader(); if(aiGenerateTasksBtn){aiGenerateTasksBtn.disabled=false; aiGenerateTasksBtn.textContent="✨ Generate Tasks";} if(aiLongPlanAdBtn)aiLongPlanAdBtn.disabled=false;}}
        function renderCalendar(year,month){if(!calendarGrid||!monthYearDisplay)return;calendarGrid.innerHTML='';const mn=["January","February","March","April","May","June","July","August","September","October","November","December"];monthYearDisplay.textContent=`${mn[month]} ${year}`;const dow=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];dow.forEach(d=>{const hc=document.createElement('div');hc.classList.add('calendar-header-cell');hc.textContent=d;calendarGrid.appendChild(hc);});const fd=new Date(year,month,1).getDay();const dim=new Date(year,month+1,0).getDate();const tdy=new Date();for(let i=0;i<fd;i++){const ec=document.createElement('div');ec.classList.add('calendar-day-cell','other-month');calendarGrid.appendChild(ec);}for(let day=1;day<=dim;day++){const dc=document.createElement('div');dc.classList.add('calendar-day-cell');const cd=new Date(year,month,day);dc.dataset.date=cd.toISOString().split('T')[0];const dn=document.createElement('span');dn.classList.add('day-number');dn.textContent=day;dc.appendChild(dn);if(year===tdy.getFullYear()&&month===tdy.getMonth()&&day===tdy.getDate()){dc.classList.add('today');}const tasksOnD=tasks.filter(t=>{if(!t.dueDate)return false;const tDate=new Date(t.dueDate+"T00:00:00");if(t.isLongEvent&&t.endDate){const teDate=new Date(t.endDate+"T00:00:00");return cd>=tDate&&cd<=teDate;}return tDate.getFullYear()===year&&tDate.getMonth()===month&&tDate.getDate()===day;});tasksOnD.slice(0,2).forEach(t=>{const tEl=document.createElement('div');tEl.classList.add('task-on-day');if(t.isLongEvent)tEl.classList.add('long-event');tEl.textContent=t.description;tEl.title=t.description;dc.appendChild(tEl);});if(tasksOnD.length>2){const mEl=document.createElement('div');mEl.classList.add('task-on-day');mEl.textContent=`+${tasksOnD.length-2} more`;dc.appendChild(mEl);}dc.addEventListener('click',()=>handleDayCellClick(dc.dataset.date));calendarGrid.appendChild(dc);}}
        function handleDayCellClick(dateStr){console.log("Day cell click:",dateStr);if(Date.now()<appSettings.longPlannerUnlockedUntil){if(longEventStartInput)longEventStartInput.value=dateStr;if(longEventEndInput)longEventEndInput.value=dateStr;if(addLongEventModal)addLongEventModal.classList.add('active');}else{showToast("Watch Ad on 'Add Long Event' button.","info");}}
        function simulateAdWatch(duration=5,successCallback,adPurpose="feature"){showLoader(`Simulating Ad for ${adPurpose}... ${duration}s`);let rem=duration;const int=setInterval(()=>{rem--;showLoader(`Simulating Ad for ${adPurpose}... ${rem}s`);if(rem<=0){clearInterval(int);hideLoader();showToast("Ad finished. Thank you!", "success");if(typeof successCallback==='function')successCallback();}},1000);}
        function formatTime(seconds){const m=Math.floor(seconds/60);const s=seconds%60;return`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;};function updatePomodoroProgressRing(){if(!pomodoroProgressRing||!appSettings.pomodoro)return;const sd=(pomodoroCurrentSession==='work'?appSettings.pomodoro.workDuration:pomodoroCurrentSession==='shortBreak'?appSettings.pomodoro.shortBreak:appSettings.pomodoro.longBreak)*60;const offset=pomodoroRingCircumference-(pomodoroTimeRemaining/sd)*pomodoroRingCircumference;pomodoroProgressRing.style.strokeDashoffset=Math.max(0,offset);};function updatePomodoroUI(){if(!pomodoroTimeDisplay||!pomodoroStatusEl||!pomodoroCycleCountEl||!pomodoroDailyUsageEl||!pomodoroFreeLimitEl||!pomodoroSkipBreakBtn||!appSettings.pomodoro)return;pomodoroTimeDisplay.textContent=formatTime(pomodoroTimeRemaining);pomodoroStatusEl.textContent=pomodoroCurrentSession==='work'?'Work Session':pomodoroCurrentSession==='shortBreak'?'Short Break':'Long Break';pomodoroCycleCountEl.textContent=pomodoroCyclesCompleted;pomodoroDailyUsageEl.textContent=appSettings.pomodoro.dailyUsageMinutes;pomodoroFreeLimitEl.textContent=appSettings.pomodoro.dailyLimitMinutes;pomodoroSkipBreakBtn.style.display=(pomodoroCurrentSession!=='work'&&pomodoroIsRunning)?'inline-flex':'none';updatePomodoroProgressRing();};function resetPomodoroDailyUsageIfNeeded(){if(!appSettings.pomodoro)return;const today=new Date().toISOString().split('T')[0];if(appSettings.pomodoro.lastUsageResetDate!==today){appSettings.pomodoro.dailyUsageMinutes=0;appSettings.pomodoro.lastUsageResetDate=today;saveData();console.log("Pomodoro daily usage reset.");}};function startNextPomodoroSession(){if(!appSettings.pomodoro)return;if(pomodoroCurrentSession==='work'){pomodoroCyclesCompleted++;appSettings.pomodoro.dailyUsageMinutes+=appSettings.pomodoro.workDuration;if(pomodoroCyclesCompleted%appSettings.pomodoro.longBreakInterval===0){pomodoroCurrentSession='longBreak';pomodoroTimeRemaining=appSettings.pomodoro.longBreak*60;}else{pomodoroCurrentSession='shortBreak';pomodoroTimeRemaining=appSettings.pomodoro.shortBreak*60;}}else{appSettings.pomodoro.dailyUsageMinutes+=(pomodoroCurrentSession==='shortBreak'?appSettings.pomodoro.shortBreak:appSettings.pomodoro.longBreak);pomodoroCurrentSession='work';pomodoroTimeRemaining=appSettings.pomodoro.workDuration*60;}saveData();updatePomodoroUI();if(appSettings.pomodoro.soundEnabled){try{new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/t-rex-roar.mp3').play();}catch(e){console.warn("Sound play failed",e)}}if(appSettings.pomodoro.autoStart){startPomodoroTimer();}else{pomodoroIsRunning=false;if(pomodoroStartPauseBtn)pomodoroStartPauseBtn.innerHTML='▶️ Start';}};function pomodoroTick(){if(pomodoroTimeRemaining>0){pomodoroTimeRemaining--;updatePomodoroUI();}else{clearInterval(pomodoroIntervalId);pomodoroIntervalId=null;startNextPomodoroSession();}};function startPomodoroTimer(){if(!appSettings.pomodoro)return;resetPomodoroDailyUsageIfNeeded();if(appSettings.pomodoro.dailyUsageMinutes>=appSettings.pomodoro.dailyLimitMinutes&&pomodoroCurrentSession==='work'){showToast("Daily Pomodoro limit reached! Watch ad.","warning");pomodoroIsRunning=false;if(pomodoroStartPauseBtn)pomodoroStartPauseBtn.innerHTML='▶️ Start';return;}if(!pomodoroIsRunning){pomodoroIsRunning=true;if(pomodoroStartPauseBtn)pomodoroStartPauseBtn.innerHTML='⏸️ Pause';pomodoroIntervalId=setInterval(pomodoroTick,1000);if(pomodoroSkipBreakBtn&&pomodoroCurrentSession!=='work')pomodoroSkipBreakBtn.style.display='inline-flex';}};function pausePomodoroTimer(){if(pomodoroIsRunning){clearInterval(pomodoroIntervalId);pomodoroIntervalId=null;pomodoroIsRunning=false;if(pomodoroStartPauseBtn)pomodoroStartPauseBtn.innerHTML='▶️ Start';}};function resetPomodoroTimer(){pausePomodoroTimer();if(!appSettings.pomodoro)return;pomodoroCurrentSession='work';pomodoroTimeRemaining=appSettings.pomodoro.workDuration*60;pomodoroCyclesCompleted=0;updatePomodoroUI();if(pomodoroStartPauseBtn)pomodoroStartPauseBtn.innerHTML='▶️ Start';};function skipPomodoroBreak(){if(pomodoroCurrentSession!=='work'&&appSettings.pomodoro){clearInterval(pomodoroIntervalId);pomodoroIntervalId=null;appSettings.pomodoro.dailyUsageMinutes+=Math.floor(((pomodoroCurrentSession==='shortBreak'?appSettings.pomodoro.shortBreak*60:appSettings.pomodoro.longBreak*60)-pomodoroTimeRemaining)/60);startNextPomodoroSession();}};function loadPomodoroSettings(){if(!pomodoroWorkDurationInput||!pomodoroShortBreakDurationInput||!pomodoroLongBreakDurationInput||!pomodoroLongBreakIntervalInput||!pomodoroAutoStartToggle||!pomodoroSoundToggle||!appSettings.pomodoro)return;pomodoroWorkDurationInput.value=appSettings.pomodoro.workDuration;pomodoroShortBreakDurationInput.value=appSettings.pomodoro.shortBreak;pomodoroLongBreakDurationInput.value=appSettings.pomodoro.longBreak;pomodoroLongBreakIntervalInput.value=appSettings.pomodoro.longBreakInterval;pomodoroAutoStartToggle.checked=appSettings.pomodoro.autoStart;pomodoroSoundToggle.checked=appSettings.pomodoro.soundEnabled;pomodoroTimeRemaining=appSettings.pomodoro.workDuration*60;updatePomodoroUI();};function savePomodoroSettings(){if(!pomodoroWorkDurationInput||!pomodoroShortBreakDurationInput||!pomodoroLongBreakDurationInput||!pomodoroLongBreakIntervalInput||!pomodoroAutoStartToggle||!pomodoroSoundToggle||!appSettings.pomodoro)return;appSettings.pomodoro.workDuration=parseInt(pomodoroWorkDurationInput.value)||25;appSettings.pomodoro.shortBreak=parseInt(pomodoroShortBreakDurationInput.value)||5;appSettings.pomodoro.longBreak=parseInt(pomodoroLongBreakDurationInput.value)||15;appSettings.pomodoro.longBreakInterval=parseInt(pomodoroLongBreakIntervalInput.value)||4;appSettings.pomodoro.autoStart=pomodoroAutoStartToggle.checked;appSettings.pomodoro.soundEnabled=pomodoroSoundToggle.checked;saveData();loadPomodoroSettings();if(pomodoroSettingsModal)pomodoroSettingsModal.classList.remove('active');showToast("Pomodoro settings saved!","success");resetPomodoroTimer();};
        
        function resetGyanSagarDailyFreeChats() { if(!appSettings.gyanSagar)return;const today=new Date().toISOString().split('T')[0];if(appSettings.gyanSagar.lastFreeChatResetDate!==today){appSettings.gyanSagar.dailyFreeChatsUsed=0;appSettings.gyanSagar.lastFreeChatResetDate=today;saveData();console.log("Gyan Sagar AI daily free chats reset.");}}
        function updateGyanSagarCreditsDisplay() { if(!gyanSagarCreditsDisplay||!appSettings.gyanSagar)return;const freeChatsLeft=Math.max(0,10-appSettings.gyanSagar.dailyFreeChatsUsed);gyanSagarCreditsDisplay.textContent=`Free: ${freeChatsLeft} | Credits: ${appSettings.gyanSagar.credits}`;if(freeChatsLeft<=0&&appSettings.gyanSagar.credits<=0){if(gyanSagarAdRewardArea)gyanSagarAdRewardArea.style.display='block';if(gyanSagarSendBtn)gyanSagarSendBtn.disabled=true;}else{if(gyanSagarAdRewardArea)gyanSagarAdRewardArea.style.display='none';if(gyanSagarSendBtn)gyanSagarSendBtn.disabled=false;}}
        function addMessageToGyanSagarChat(text,sender='user',isNewMessage=true){if(!gyanSagarChatArea)return;const msgDiv=document.createElement('div');msgDiv.classList.add('gyansagar-message',sender);msgDiv.textContent=text;gyanSagarChatArea.appendChild(msgDiv);gyanSagarChatArea.scrollTop=gyanSagarChatArea.scrollHeight;if(isNewMessage){currentGyanSagarChatSession.push({sender,text,timestamp:Date.now()});}}
        function saveCurrentGyanSagarChatSession(){if(!appSettings.gyanSagar||currentGyanSagarChatSession.length===0)return;if(currentChatSessionId){const idx=appSettings.gyanSagar.chatHistory.findIndex(s=>s.id===currentChatSessionId);if(idx>-1){appSettings.gyanSagar.chatHistory[idx].messages=[...currentGyanSagarChatSession];appSettings.gyanSagar.chatHistory[idx].lastUpdated=Date.now();}else{appSettings.gyanSagar.chatHistory.unshift({id:currentChatSessionId,messages:[...currentGyanSagarChatSession],timestamp:currentGyanSagarChatSession[0]?.timestamp||Date.now(),lastUpdated:Date.now()});}}else if(currentGyanSagarChatSession.length>0){const newId=Date.now() + Math.random(); appSettings.gyanSagar.chatHistory.unshift({id:newId,messages:[...currentGyanSagarChatSession],timestamp:currentGyanSagarChatSession[0]?.timestamp||Date.now(),lastUpdated:Date.now()});currentChatSessionId=newId;}if(appSettings.gyanSagar.chatHistory.length>20){appSettings.gyanSagar.chatHistory.pop();}saveData();}
        async function handleGyanSagarSend(){if(!gyanSagarUserInput||!appSettings.gyanSagar)return;const question=gyanSagarUserInput.value.trim();if(!question)return;resetGyanSagarDailyFreeChats();if(appSettings.gyanSagar.dailyFreeChatsUsed>=10&&appSettings.gyanSagar.credits<=0){showToast("No free chats or credits. Watch ad.","warning");if(gyanSagarAdRewardArea)gyanSagarAdRewardArea.style.display='block';return;}addMessageToGyanSagarChat(question,'user');gyanSagarUserInput.value='';if(gyanSagarTypingIndicator)gyanSagarTypingIndicator.style.display='block';showLoader("ज्ञान सागर AI is thinking...");if(gyanSagarSendBtn)gyanSagarSendBtn.disabled=true;const systemPromptForQA=`You are "ज्ञान सागर AI", a highly knowledgeable and helpful AI assistant. Provide accurate and comprehensive answers to the user's questions across various subjects like math, physics, chemistry, history, geography, literature, etc. If you don't know an answer, state that clearly. Keep responses concise yet informative. User's question: "${question}"`;try{const response=await fetch(GEMINI_API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:systemPromptForQA}]}]})});if(!response.ok){const errText=await response.text();console.error("GS API Error:",errText);let errMessage=`API Error: ${response.status}`;try{const errData=JSON.parse(errText);errMessage+=` ${errData.error?.message||''}`; }catch(e){errMessage+=` - ${errText.substring(0,100)}`;}throw new Error(errMessage);}const data=await response.json();const aiAnswer=data.candidates?.[0]?.content?.parts?.[0]?.text||"Sorry, I couldn't process that.";addMessageToGyanSagarChat(aiAnswer,'ai');if(appSettings.gyanSagar.dailyFreeChatsUsed<10){appSettings.gyanSagar.dailyFreeChatsUsed++;}else{appSettings.gyanSagar.credits=Math.max(0,appSettings.gyanSagar.credits-1);}saveCurrentGyanSagarChatSession();updateGyanSagarCreditsDisplay();}catch(error){console.error("Error with Gyan Sagar AI:",error);addMessageToGyanSagarChat(`Sorry, an error occurred: ${error.message}`,'ai');showToast(`Gyan Sagar AI Error: ${error.message}`,"error");}finally{hideLoader();if(gyanSagarTypingIndicator)gyanSagarTypingIndicator.style.display='none';if(gyanSagarSendBtn)gyanSagarSendBtn.disabled=false;updateGyanSagarCreditsDisplay();}}
        function renderChatHistory(){if(!chatHistoryListEl||!noChatHistoryMsg||!appSettings.gyanSagar)return;chatHistoryListEl.innerHTML='';const sortedHistory=[...appSettings.gyanSagar.chatHistory].sort((a,b)=>b.lastUpdated-a.lastUpdated);if(sortedHistory.length===0){noChatHistoryMsg.style.display='block';return;}noChatHistoryMsg.style.display='none';sortedHistory.forEach(session=>{if(!session.messages||session.messages.length===0)return;const firstUserMsg=session.messages.find(m=>m.sender==='user');const preview=firstUserMsg?firstUserMsg.text.substring(0,50)+"...":"Chat Session";const itemDiv=document.createElement('div');itemDiv.classList.add('chat-history-item');itemDiv.dataset.sessionId=session.id;itemDiv.innerHTML=`<div class="chat-history-item-header"><div class="history-item-preview">${preview}</div><span class="history-message-count">${session.messages.length} msgs</span></div><div class="history-item-date">Last active: ${new Date(session.lastUpdated).toLocaleString()}</div>`;itemDiv.addEventListener('click',()=>loadChatSession(session.id));chatHistoryListEl.appendChild(itemDiv);});}
        function loadChatSession(sessionId){if(!appSettings.gyanSagar)return;const session=appSettings.gyanSagar.chatHistory.find(s=>s.id===sessionId);if(session&&session.messages){currentGyanSagarChatSession=[...session.messages];currentChatSessionId=sessionId;if(gyanSagarChatArea)gyanSagarChatArea.innerHTML='';session.messages.forEach(msg=>{addMessageToGyanSagarChat(msg.text,msg.sender,false);});showPage('gyansagar-ai-page');}else{showToast("Could not load session.","error");}}

        function setupEventListeners() {
            console.log("Setting up event listeners...");
            allNavLinks.forEach(link => { if (link.dataset.page) { link.addEventListener('click', (e) => { e.preventDefault(); const pId = link.dataset.page; const act = link.dataset.action; if (pId === 'add-edit-task-page' && act === 'add') { editingTaskId = null; prepareTaskForm(); } showPage(pId); if (sidenav && sidenav.classList.contains('active')) { toggleSidenav(false); } }); }});
            if (hamburgerBtn) hamburgerBtn.addEventListener('click', () => toggleSidenav());
            if (sidenavCloseBtn) sidenavCloseBtn.addEventListener('click', () => toggleSidenav(false));
            if (sidenavOverlay) sidenavOverlay.addEventListener('click', () => toggleSidenav(false));
            if (referOnWhatsAppBtn) { referOnWhatsAppBtn.addEventListener('click', (e) => { e.preventDefault(); const refCode = getOrSetUserReferralCode(); const appName = "TaskOracle AI"; const appURL = window.location.href.split('#')[0]; let message = `Hey! Check out ${appName}!\nTry it: ${appURL}\nMy referral code: ${refCode}`; const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`; window.open(whatsappUrl, '_blank'); toggleSidenav(false); }); }
            if (darkModeToggle) { darkModeToggle.addEventListener('change', () => { if(appSettings) appSettings.darkMode = darkModeToggle.checked; saveData(); applyTheme(); }); }
            if (notificationsToggle) { notificationsToggle.addEventListener('change', () => { if(appSettings) appSettings.notificationsEnabled = notificationsToggle.checked; saveData(); applyNotificationSetting(); showToast(`Notifications ${appSettings.notificationsEnabled?'on':'off'}.`); });}
            if (aiAssistantFab) { aiAssistantFab.addEventListener('click', () => { if(aiAssistantModalOverlay) aiAssistantModalOverlay.classList.add('active'); if(aiPromptInput) aiPromptInput.focus(); });}
            if (aiModalCloseBtn) { aiModalCloseBtn.addEventListener('click', () => { if(aiAssistantModalOverlay) aiAssistantModalOverlay.classList.remove('active'); });}
            if (aiAssistantModalOverlay) { aiAssistantModalOverlay.addEventListener('click', (e) => { if (e.target === aiAssistantModalOverlay) aiAssistantModalOverlay.classList.remove('active'); });}
            if (aiGenerateTasksBtn) { aiGenerateTasksBtn.addEventListener('click', () => handleAIGenerateTasks(false)); }
            if (aiLongPlanAdBtn) { aiLongPlanAdBtn.addEventListener('click', () => { if((appSettings.aiLongPlanQuota && appSettings.aiLongPlanQuota > 0) || Date.now() < (appSettings.longPlannerUnlockedUntil || 0) ) { handleAIGenerateTasks(true); } else { simulateAdWatch(5, () => { appSettings.aiLongPlanQuota = (appSettings.aiLongPlanQuota || 0) + 3; saveData(); handleAIGenerateTasks(true); }, "AI Long Plan");}}); }
            if (quickAddForm) { quickAddForm.addEventListener('submit', (e) => { e.preventDefault(); if (!quickAddInput) return; const raw = quickAddInput.value.trim(); if (!raw) return; const nt = parseQuickAddString(raw); if (nt && nt.description) { tasks.push(nt); saveData(); renderAll(); quickAddInput.value = ''; showToast('Task added!', 'success'); sendNotification('Task Added', nt.description); } else { showToast('Invalid quick add.', 'error'); } }); }
            if (taskForm) { taskForm.addEventListener('submit', (e) => { e.preventDefault(); if(!taskDescriptionInput||!descriptionError||!taskDueDateInput||!taskDueTimeInput||!taskTagsInput||!taskPriorityInput){console.error("Task form UI missing"); return;} descriptionError.textContent=''; const desc=taskDescriptionInput.value.trim(); if(!desc){descriptionError.textContent='Required.';taskDescriptionInput.focus();return;} const dd=taskDueDateInput.value||null;const dt=taskDueTimeInput.value||null;const tgs=taskTagsInput.value.split(',').map(t=>t.trim().toLowerCase()).filter(t=>t);const prio=taskPriorityInput.value;const taskData=createTaskObjectFromInput(desc,dd,dt,tgs,prio);taskData.id=editingTaskId||taskData.id;taskData.completed=editingTaskId?(tasks.find(t=>t.id===editingTaskId)?.completed||false):false;taskData.createdAt=editingTaskId?(tasks.find(t=>t.id===editingTaskId)?.createdAt||Date.now()):Date.now();taskData.completedAt=editingTaskId?(tasks.find(t=>t.id===editingTaskId)?.completedAt||null):null;if(editingTaskId){const idx=tasks.findIndex(t=>t.id===editingTaskId);if(idx>-1)tasks[idx]=taskData;showToast('Task updated!','success');}else{tasks.push(taskData);showToast('Task added!','success');sendNotification('Task Added',taskData.description);}editingTaskId=null;saveData();renderAll();showPage('task-list-page');});}
            if (changeAvatarBtn) { changeAvatarBtn.addEventListener('click', () => { if(avatarUploadInput) avatarUploadInput.click(); });}
            if (avatarUploadInput) { avatarUploadInput.addEventListener('change', (event) => { const file = event.target.files[0]; if(file){if(file.size > 1*1024*1024){showToast('Image < 1MB.','error');avatarUploadInput.value='';return;} const reader=new FileReader();reader.onload=(e)=>{userProfile.avatarDataUrl=e.target.result;saveData();updateProfileDisplay();showToast('Avatar updated!','success');};reader.onerror=()=>{showToast('Error reading file.','error');avatarUploadInput.value='';};reader.readAsDataURL(file);}});}
            if (profileForm) { profileForm.addEventListener('submit', (e) => {e.preventDefault(); if(!userNameInput || !userEmailInput) return; userProfile.name = userNameInput.value.trim(); userProfile.email = userEmailInput.value.trim(); if(!userProfile.avatarDataUrl){userProfile.avatarChar = userProfile.name ? userProfile.name.charAt(0).toUpperCase() : 'U';} saveData(); updateProfileDisplay(); showToast('Profile saved!', 'success');});}
            if (clearAllTasksBtn) { clearAllTasksBtn.addEventListener('click', () => {if(confirm('Delete ALL tasks?')){tasks=[];saveData();renderAll();showToast('All tasks cleared.','success');}});}
            const resetAppHandler = () => {if(confirm('RESET ALL APP DATA?')){tasks=[];userProfile={name:'',email:'',avatarChar:'U',avatarDataUrl:null, referralCode: null};appSettings={darkMode:false,notificationsEnabled:false,longPlannerUnlockedUntil:0,aiLongPlanQuota:0, pomodoro: { workDuration: 25, shortBreak: 5, longBreak: 15, longBreakInterval: 4, autoStart: true, soundEnabled: true, dailyUsageMinutes: 0, dailyLimitMinutes: 120, lastUsageResetDate: new Date().toISOString().split('T')[0]}, gyanSagar: { dailyFreeChatsUsed: 0, lastFreeChatResetDate: new Date().toISOString().split('T')[0], credits: 0, chatHistory: [] }};localStorage.removeItem('TC_tasks');localStorage.removeItem('TC_userProfile');localStorage.removeItem('TC_appSettings');saveData();renderAll();showToast('App data reset.','success');showPage('home-page');}};
            if (resetAppDataProfileBtn) { resetAppDataProfileBtn.addEventListener('click', resetAppHandler); }
            if (resetAppDataSettingsBtn) { resetAppDataSettingsBtn.addEventListener('click', resetAppHandler); }
            if (filterTabsContainer) { filterTabsContainer.addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON'){document.querySelectorAll('#filter-tabs-container button').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');currentFilter=e.target.dataset.filter;renderTaskList();}});}
            if (searchTaskInput) { searchTaskInput.addEventListener('input', (e)=>{currentSearchTerm=e.target.value;renderTaskList();});}
            if (taskListUl) { taskListUl.addEventListener('click', (e)=>{const tgt=e.target;const tIdStr=tgt.dataset.id||tgt.closest('.task-item-card')?.dataset.id; if(!tIdStr)return;const tId=parseFloat(tIdStr);if(tgt.classList.contains('task-checkbox')){toggleTaskComplete(tId);}else if(tgt.classList.contains('edit-btn')||tgt.closest('.edit-btn')){editingTaskId=tId;prepareTaskForm(tId);showPage('add-edit-task-page');}else if(tgt.classList.contains('delete-btn')||tgt.closest('.delete-btn')){deleteTask(tId);}}); }
            document.querySelectorAll('.add-task-from-list-btn, .back-to-tasks-btn, .cancel-task-form-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.preventDefault(); const pageId = btn.dataset.page; const action = btn.dataset.action; if (pageId === 'add-edit-task-page' && action === 'add') { editingTaskId = null; prepareTaskForm(); } showPage(pageId); }); });
            if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); });
            if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); });
            if (addLongEventAdBtn) { addLongEventAdBtn.addEventListener('click', () => { if (Date.now() < appSettings.longPlannerUnlockedUntil) { if(addLongEventModal) addLongEventModal.classList.add('active'); } else { simulateAdWatch(5, () => { appSettings.longPlannerUnlockedUntil = Date.now() + (24*60*60*1000); saveData(); if(addLongEventModal) addLongEventModal.classList.add('active'); }, "Long Event Planner");}}); }
            if (longEventModalCloseBtn) longEventModalCloseBtn.addEventListener('click', () => { if(addLongEventModal) addLongEventModal.classList.remove('active'); });
            if (addLongEventModal) addLongEventModal.addEventListener('click', e => { if(e.target === addLongEventModal) addLongEventModal.classList.remove('active');});
            if (longEventSaveBtn) { longEventSaveBtn.addEventListener('click', () => { if (!longEventDescInput || !longEventStartInput || !longEventEndInput) return; const desc = longEventDescInput.value.trim(); const start = longEventStartInput.value; const end = longEventEndInput.value; if (!desc || !start) { showToast("Desc & start date required.", "error"); return; } if (end && new Date(end) < new Date(start)) { showToast("End date before start.", "error"); return; } tasks.push(createTaskObjectFromInput(desc, start, null, [], '2', true, end || null)); saveData(); renderAll(); if(addLongEventModal) addLongEventModal.classList.remove('active'); longEventDescInput.value = ''; longEventStartInput.value = ''; longEventEndInput.value = ''; showToast("Long event added!", "success");});}
            if(pomodoroStartPauseBtn) pomodoroStartPauseBtn.addEventListener('click', () => { pomodoroIsRunning ? pausePomodoroTimer() : startPomodoroTimer(); });
            if(pomodoroResetBtn) pomodoroResetBtn.addEventListener('click', resetPomodoroTimer);
            if(pomodoroSkipBreakBtn) pomodoroSkipBreakBtn.addEventListener('click', skipPomodoroBreak);
            if(pomodoroSettingsBtn) pomodoroSettingsBtn.addEventListener('click', () => { loadPomodoroSettings(); if(pomodoroSettingsModal) pomodoroSettingsModal.classList.add('active'); });
            if(pomodoroSettingsCloseBtn) pomodoroSettingsCloseBtn.addEventListener('click', () => { if(pomodoroSettingsModal) pomodoroSettingsModal.classList.remove('active'); });
            if(pomodoroSettingsModal) pomodoroSettingsModal.addEventListener('click', e => { if(e.target === pomodoroSettingsModal) pomodoroSettingsModal.classList.remove('active'); });
            if(pomodoroSettingsSaveBtn) pomodoroSettingsSaveBtn.addEventListener('click', savePomodoroSettings);
            if(pomodoroExtendTimeAdBtn) { pomodoroExtendTimeAdBtn.addEventListener('click', () => { simulateAdWatch(5, () => { if(appSettings.pomodoro) appSettings.pomodoro.dailyLimitMinutes += 30; saveData(); updatePomodoroUI(); showToast("Pomodoro time extended!", "success");}, "Pomodoro Time"); }); }
            
            // Gyan Sagar AI Listeners
            if (gyanSagarSendBtn) { gyanSagarSendBtn.addEventListener('click', handleGyanSagarSend); }
            if (gyanSagarUserInput) { gyanSagarUserInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleGyanSagarSend(); }});}
            if (gyanSagarWatchAdBtn) { gyanSagarWatchAdBtn.addEventListener('click', () => { simulateAdWatch(5, () => { if (appSettings.gyanSagar) { appSettings.gyanSagar.credits += 5; saveData(); updateGyanSagarCreditsDisplay(); showToast("5 Chat Credits added!", "success");}}, "Gyan Sagar Credits");});}

            console.log("Event listeners setup complete.");
        }

        function initializeApp() { 
            console.log("initializeApp started."); 
            loadData(); getOrSetUserReferralCode(); setupEventListeners(); 
            resetPomodoroDailyUsageIfNeeded(); 
            resetGyanSagarDailyFreeChats(); // Initialize Gyan Sagar daily limits
            const pageIdFromHash = window.location.hash.substring(1);
            let initialPageId = 'home-page'; 
            if (pageIdFromHash && document.getElementById(pageIdFromHash + '-page')) {
                initialPageId = pageIdFromHash + '-page';
            } else if (pageIdFromHash) { 
                window.location.hash = 'home';
            }
            renderAll(); 
            showPage(initialPageId);
            window.addEventListener('popstate', () => { const newPageIdFromHash = window.location.hash.substring(1) || 'home'; const targetPage = newPageIdFromHash + '-page'; if(document.getElementById(targetPage)) { showPage(targetPage); } else { showPage('home-page'); }}); 
            if (!window.location.hash && initialPageId === 'home-page') { try { window.history.replaceState(null, '', '#home'); } catch(e) { console.warn("Could not set initial hash")}} 
            setInterval(() => { if (appSettings.notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') { const todayStr = new Date().toISOString().split('T')[0]; if (!window.notifiedTasksToday) window.notifiedTasksToday = {}; const dueTodayTasks = tasks.filter(task => !task.completed && task.dueDate === todayStr && !window.notifiedTasksToday[task.id]); dueTodayTasks.forEach(task => { sendNotification('Task Due Today!', task.description); window.notifiedTasksToday[task.id] = true;});}}, 15 * 60 * 1000); 
            console.log("App initialized.");
        }
        initializeApp(); 
    }); 
    </script>
</body>
</html>
